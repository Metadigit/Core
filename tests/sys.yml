# =========================================================
# SYS configuration
# =========================================================

sys:
  # -------------------------------------------------------
  # APPs definitions ======================================
  apps:
    MNGR:
      domain:     example.com
      port:       8080
      url:        /
      namespace:  mngr
    API_FOO:
      url:        /api/foo/
      namespace:  api.foo
    API_BAR:
      url:        /api/bar/
      namespace:  api.bar
    UI:
      port:       80
      url:        /
      namespace:  ui

  # -------------------------------------------------------
  # CLI definitions ---------------------------------------
  cli:
    console:      test.console

  # -------------------------------------------------------
  # __autoload map namespace/directory --------------------
  namespaces:
    test:           /
    metadigit\lib:  /opt/metadigit-lib/src

  # -------------------------------------------------------
  # Environment constants ---------------------------------
  constants:
    ASSETS_DIR:   /var/www/devel.com/data/assets/
    ASSETS_URL:   /assets/
    UPLOAD_DIR:   /var/www/devel.com/data/files/
    SWIFT_DIR:    phar://${BASE_DIR}swift-mailer-4.3.0.phar/

  # -------------------------------------------------------
  # Php settings ------------------------------------------
  settings:
    charset:      UTF-8
    locale:       en_GB.UTF-8
    timeZone:     Europe/London

  # -------------------------------------------------------
  # CACHE settings ----------------------------------------
  cache:
    #sys:           ### System cache, override with CAUTION
      #class:       renovant\core\cache\SqliteCache
      #constructor: ['sys-cache', 'cache', true]
    main:
      class:        renovant\core\cache\SqliteCache
      constructor:  [ 'sqlite', 'cache', false ]


  # -------------------------------------------------------
  # DB settings -------------------------------------------
  database:
    sys-cache:  ### System cache DB, override with CAUTION
      #dns:      sqlite:{{CACHE_DIR}}sys-cache.sqlite
      dns:      sqlite:file:sys-cache?mode=memory
    sys-trace:  ### System trace DB, override with CAUTION
      #dns:      sqlite:{{DATA_DIR}}sys-trace.sqlite
      dns:      sqlite:file:sys-trace?mode=memory
    sqlite:
      #dns:      sqlite:/tmp/renovant-core/db.sqlite
      dns:      sqlite:file:sqlite?mode=memory
    mysql:
      dns:      mysql:unix_socket=/run/mysqld/mysqld.sock;dbname=phpunit
      user:     phpunit
      pwd:      phpunit

  # -------------------------------------------------------
  # LOG settings ------------------------------------------
  log:
    kernel:
      level:    LOG_INFO
      facility: kernel
      class:    renovant\core\log\writer\FileWriter
      param1:   kernel.log
      param2:   null
    system:
      level:    LOG_DEBUG
      facility: null
      class:    renovant\core\log\writer\FileWriter
      param1:   system.log
      param2:   null

  # -------------------------------------------------------
  # TRACE settings ----------------------------------------
  trace:
    level:      LOG_DEBUG
    storeFn:    null

  # -------------------------------------------------------
  # sys services override ---------------------------------
  services:
    acl:        sys.ACL
    auth:       sys.AUTH
    cmd:        sys.CmdManager

# =========================================================
# EVENTS
# =========================================================
events:
  HTTP:ROUTE:
    - sys.HttpSession->start
    #- sys.AUTH->init
    #- sys.ACL->init
  HTTP:VIEW:
    #- sys.AUTH->commit
    - sys.HttpSession->end
  HTTP:EXCEPTION:
    #- sys.AUTH->commit
    - sys.HttpSession->end

# =========================================================
# SERVICES
# =========================================================
services:

  # -------------------------------------------------------
  # ACL service
  # -------------------------------------------------------
  sys.ACL:
    class: renovant\core\acl\ACL
    constructor:
      # available modules: ORM, ROUTING, SERVICES
      modules: [ 'ORM', 'ROUTING', 'SERVICES' ]
      pdo: mysql
      tables:
        acl:    sys_acl
        users:  sys_users
        roles:  sys_roles
        u2r:    sys_users_2_roles

  # -------------------------------------------------------
  # AUTH service
  # -------------------------------------------------------
  sys.AUTH:
    class: renovant\core\auth\AUTH
    constructor:
      module: SESSION
    properties:
      authTTL:      300     # 5 min
      refreshTTL:   86400   # 1 day
      rememberTTL:  2592000 # 1 month
      provider:     sys.AuthProvider
      skipAuthApps: [ 'AUTH' ]
      skipAuthUrls: []
      skipXSRFApps: [ 'RRD' ]
      skipXSRFUrls: [ '/^\/api\/auth\/login$/' ]

  sys.AuthProvider:
    class: renovant\core\auth\provider\PdoProvider
    constructor:
      pdo:        mysql
      tables:
        auth:     sys_auth
        tokens:   sys_tokens
        users:    sys_users
    properties:
      fields:     '*'

  # =========================================================
  # CmdManager service
  # =========================================================
  sys.CmdManager:
    class: renovant\core\console\CmdManager
    constructor:
      pdo:    sqlite
      table:  sys_cmd

  # -------------------------------------------------------
  # SESSION service
  # -------------------------------------------------------
  sys.HttpSession:
    class: renovant\core\http\session\Manager
    constructor:
      # session cookie parameters
      cookie:
        name:     SESSION   # cookie name
        lifetime: 3600      # lifetime of the session cookie, defined in seconds
        path:     /         # path on the domain where the cookie will work (use a single slash '/' for all paths on the domain)
        domain:   null      # cookie domain (to make cookies visible on all sub-domains then the domain must be prefixed with a dot like '.php.net')
        secure:   true      # if TRUE cookie will only be sent over secure connections
        httponly: true      #
      # session handler
      handler:
        class: renovant\core\http\session\handler\Mysql
        properties:
          pdo:    mysql
          table:  sys_sessions

  # -------------------------------------------------------
  # QUEUE service
  # -------------------------------------------------------
  sys.Queue:
    class: renovant\core\queue\Queue
    constructor:
      pdo:        mysql
      table:      sys_queue
    properties:
      fields:     '*'
