# =========================================================
# APPs definitions
# =========================================================
apps:
  MNGR:
    domain:     example.com
    port:       8080
    url:        /
    namespace:  mngr
  API_FOO:
    url:        /api/foo/
    namespace:  api.foo
  API_BAR:
    url:        /api/bar/
    namespace:  api.bar
  UI:
    port:       80
    url:        /
    namespace:  ui

# =========================================================
# CLI definitions
# =========================================================
cli:
  console:      test.console

# =========================================================
# __autoload map namespace/directory
# =========================================================
namespaces:
  test:           /
  metadigit\lib:  /opt/metadigit-lib/src

# =========================================================
# Environment constants
# =========================================================
constants:
  ASSETS_DIR:   /var/www/devel.com/data/assets/
  ASSETS_URL:   /assets/
  UPLOAD_DIR:   /var/www/devel.com/data/files/
  SWIFT_DIR:    phar://${BASE_DIR}swift-mailer-4.3.0.phar/

# =========================================================
# Php settings
# =========================================================
settings:
  charset:      UTF-8
  locale:       en_GB.UTF-8
  timeZone:     Europe/London

# =========================================================
# CACHE service
# =========================================================
cache:
  #sys:           ### System cache, override with CAUTION
    #class:       metadigit\core\cache\SqliteCache
    #constructor: ['sys-cache', 'cache', true]
  main:
    class:        metadigit\core\cache\SqliteCache
    constructor:  [ 'sqlite', 'cache', false ]

# =========================================================
# CmdManager service
# =========================================================
sys.CmdManager:
  # class: metadigit\core\console\CmdManager
  constructor:
    pdo:    sqlite
    table:  sys_cmd

# =========================================================
# DB service
# =========================================================
database:
  #sys-cache:  ### System cache DB, override with CAUTION
  #  dns:      sqlite:{{CACHE_DIR}}sys-cache.sqlite
  #sys-trace:  ### System trace DB, override with CAUTION
  #  dns:      sqlite:{{DATA_DIR}}sys-trace.sqlite
  sqlite:
    dns:      sqlite:/tmp/metadigit-core/db.sqlite
  mysql:
    dns:      mysql:unix_socket=/run/mysqld/mysqld.sock;dbname=phpunit
    user:     phpunit
    pwd:      phpunit

# =========================================================
# LOG service
# =========================================================
log:
  kernel:
    level:    LOG_INFO
    facility: kernel
    class:    metadigit\core\log\writer\FileWriter
    param1:   kernel.log
    param2:   null
  system:
    level:    LOG_DEBUG
    facility: null
    class:    metadigit\core\log\writer\FileWriter
    param1:   system.log
    param2:   null

# =========================================================
# TRACE service
# =========================================================
trace:
  level:      LOG_DEBUG
  storeFn:    null

# =========================================================
# EVENTS
# =========================================================
events:
  HTTP:ROUTE:
    - sys.HttpSession->start
    #- sys.AUTH->init
    #- sys.ACL->init
  HTTP:VIEW:
    #- sys.AUTH->commit
    - sys.HttpSession->end
  HTTP:EXCEPTION:
    #- sys.AUTH->commit
    - sys.HttpSession->end

# =========================================================
# SERVICES
# =========================================================
services:

  # -------------------------------------------------------
  # ACL service
  # -------------------------------------------------------
  sys.ACL:
    class: metadigit\core\acl\ACL
    constructor:
      # available modules: ORM, ROUTING, SERVICES
      modules: [ 'ORM', 'ROUTING', 'SERVICES' ]
      pdo: mysql
      tables:
        acl:    sys_acl
        users:  sys_users
        roles:  sys_roles
        u2r:    sys_users_2_roles

  # -------------------------------------------------------
  # AUTH service
  # -------------------------------------------------------
  sys.AUTH:
    class: metadigit\core\auth\AUTH
    constructor:
      module: SESSION
    properties:
      authTTL:      300   # 5 min
      refreshTTL:   86400 # 1 day
      skipAuthApps: [ 'AUTH' ]
      skipAuthUrls: []
      skipXSRFApps: [ 'RRD' ]
      skipXSRFUrls: [ '/^\/api\/auth\/login$/' ]

  sys.AuthProvider:
    class: metadigit\core\auth\provider\PdoProvider
    constructor:
      pdo:        mysql
      tableAuth:  sys_auth
      tableUsers: users
    properties:
      fields:     '*'

  # -------------------------------------------------------
  # SESSION service
  # -------------------------------------------------------
  sys.HttpSession:
    class: metadigit\core\http\session\Manager
    constructor:
      # session cookie parameters
      cookie:
        name:     SESSION   # cookie name
        lifetime: 3600      # lifetime of the session cookie, defined in seconds
        path:     /         # path on the domain where the cookie will work (use a single slash '/' for all paths on the domain)
        domain:   null      # cookie domain (to make cookies visible on all sub-domains then the domain must be prefixed with a dot like '.php.net')
        secure:   true      # if TRUE cookie will only be sent over secure connections
        httponly: true      #
      # session handler
      handler:
        class: metadigit\core\http\session\handler\Mysql
        properties:
          pdo:    mysql
          table:  sys_sessions
